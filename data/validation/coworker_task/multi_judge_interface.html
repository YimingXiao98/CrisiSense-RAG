<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Judge Human Validation - 25 Queries</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }
      .header p {
        font-size: 16px;
        opacity: 0.9;
      }
      .progress {
        background: #f5f5f5;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
      }
      .progress-bar {
        width: 100%;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }
      .query-card {
        border-bottom: 2px solid #e0e0e0;
        padding: 30px;
      }
      .query-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .query-id {
        background: #667eea;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
      }
      .section {
        margin-bottom: 20px;
      }
      .section-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 8px 12px;
        border-radius: 4px;
        display: inline-block;
      }
      .query-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }
      .context-box {
        background: #f0f7ff;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
        max-height: 600px;
        overflow-y: auto;
      }
      .context-box h4 {
        margin-bottom: 10px;
        color: #1565c0;
      }
      .context-box ul {
        margin-left: 20px;
        font-size: 13px;
      }
      .context-box li {
        margin: 5px 0;
      }
      .response-box {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
      }
      .response-box pre {
        white-space: pre-wrap;
        font-size: 13px;
        background: #fffbea;
        padding: 10px;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
      }
      .ground-truth-box {
        background: #d4edda;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }
      .judges-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .judge-card {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #90caf9;
      }
      .judge-card.gpt4o {
        border-color: #10a37f;
        background: #e8f5e9;
      }
      .judge-card.gemini {
        border-color: #4285f4;
        background: #e3f2fd;
      }
      .judge-card.hf {
        border-color: #ff9800;
        background: #fff3e0;
      }
      .judge-name {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .judge-scores {
        display: flex;
        gap: 15px;
      }
      .score-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: bold;
      }
      .score-badge.high {
        background: #c8e6c9;
        color: #2e7d32;
      }
      .score-badge.medium {
        background: #fff9c4;
        color: #f57f17;
      }
      .score-badge.low {
        background: #ffcdd2;
        color: #c62828;
      }
      .scoring-section {
        background: #f0f7ff;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #667eea;
        margin-top: 20px;
      }
      .scoring-section h3 {
        color: #667eea;
        margin-bottom: 15px;
      }
      .score-input-group {
        margin-bottom: 15px;
      }
      .score-input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
      }
      .score-input-group input[type="number"] {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
      }
      .score-input-group input:focus {
        outline: none;
        border-color: #667eea;
      }
      .score-input-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        min-height: 80px;
        font-family: inherit;
      }
      .navigation {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        gap: 10px;
      }
      .nav-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      .nav-btn:hover {
        background: #5568d3;
      }
      .export-btn {
        background: #28a745;
        position: fixed;
        bottom: 30px;
        left: 30px;
        padding: 15px 30px;
        border-radius: 25px;
        color: white;
        border: none;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
      }
      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
      }
      .badge-severe {
        background: #dc3545;
        color: white;
      }
      .badge-moderate {
        background: #ffc107;
        color: #333;
      }
      .badge-minor {
        background: #17a2b8;
        color: white;
      }
      .badge-none {
        background: #6c757d;
        color: white;
      }
      .collapsible {
        cursor: pointer;
        user-select: none;
      }
      .collapsible:after {
        content: " ‚ñº";
        font-size: 10px;
      }
      .collapsed:after {
        content: " ‚ñ∂";
      }
      .collapsed + .collapsible-content {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéØ Human Validation Task</h1>
        <p>Score 25 queries for Faithfulness and Relevance</p>
      </div>

      <div class="progress">
        <div>
          <strong>Progress:</strong>
          <span id="progress-text">0/25 queries scored</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill">0%</div>
        </div>
      </div>

      <div id="queries-container"></div>
    </div>

    <button class="export-btn" onclick="exportToCSV()">üíæ Export to CSV</button>

    <div class="navigation">
      <button class="nav-btn" onclick="scrollToQuery(-1)">‚¨Ü Previous</button>
      <button class="nav-btn" onclick="scrollToQuery(1)">‚¨á Next</button>
    </div>

    <script>
      let currentQuery = 0;
      let scores = [];
      let rawData = null;

      // Load data from multi-judge validation file
      fetch("multi_judge_validation_25.json")
        .then((r) => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then((data) => {
          rawData = data;
          renderQueries(data.records);
          scores = data.records.map(() => ({
            faithfulness: null,
            relevance: null,
            notes: "",
          }));
        })
        .catch((err) => {
          console.error("Error loading data:", err);
          document.getElementById("queries-container").innerHTML = `
            <div style="padding: 30px; color: #333;">
              <h2 style="color: red; margin-bottom: 15px;">‚ö†Ô∏è Cannot load data file</h2>
              <p><strong>Error:</strong> ${err.message}</p>
              <p style="margin-top: 15px;">This is likely a browser security restriction. To fix, run a local web server:</p>
              <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; overflow-x: auto;">
cd /data4/Yiming_shared/coworker_task
python3 -m http.server 8080</pre>
              <p>Then open: <a href="http://localhost:8080/multi_judge_interface.html">http://localhost:8080/multi_judge_interface.html</a></p>
            </div>`;
        });

      function renderQueries(queries) {
        const container = document.getElementById("queries-container");

        queries.forEach((q, idx) => {
          const card = document.createElement("div");
          card.className = "query-card";
          card.id = `query-${idx}`;

          const severityBadge = getSeverityBadge(
            q.ground_truth.actual_damage_pct
          );

          // Build context HTML
          const contextHtml = buildContextHtml(q.retrieved_context);

          // Build judge scores HTML
          const judgeScoresHtml = buildJudgeScoresHtml(q.judge_scores);

          card.innerHTML = `
            <div class="query-header">
              <span class="query-id">Query ${q.query_id}/25</span>
              ${severityBadge}
            </div>

            <!-- Query Info -->
            <div class="section">
              <div class="section-title" style="background: #f8f9fa;">üìç Query</div>
              <div class="query-info">
                <div class="info-grid">
                  <div><strong>ZIP:</strong> ${q.query.zip}</div>
                  <div><strong>Dates:</strong> ${q.query.start_date} to ${
            q.query.end_date
          }</div>
                </div>
              </div>
            </div>

            <!-- Retrieved Context (Collapsible) -->
            <div class="section">
              <div class="section-title collapsible" style="background: #e3f2fd;" 
                   onclick="this.classList.toggle('collapsed')">üìö Retrieved Context</div>
              <div class="collapsible-content">
                ${contextHtml}
              </div>
            </div>

            <!-- Model Response -->
            <div class="section">
              <div class="section-title" style="background: #fff3cd;">ü§ñ Model Response</div>
              <div class="response-box">
                <strong>Damage Estimate:</strong> ${
                  q.model_response.damage_pct
                }% (Confidence: ${q.model_response.confidence})<br><br>
                <strong>Full Response:</strong>
                <pre>${
                  q.model_response.formatted ||
                  JSON.stringify(q.model_response.raw, null, 2)
                }</pre>
              </div>
            </div>

            <!-- Ground Truth -->
            <div class="section">
              <div class="section-title" style="background: #d4edda;">‚úÖ Ground Truth (Insurance Claims)</div>
              <div class="ground-truth-box">
                <div class="info-grid">
                  <div><strong>Actual Damage:</strong> ${
                    q.ground_truth.actual_damage_pct
                  }%</div>
                  <div><strong>Claims Filed:</strong> ${
                    q.ground_truth.claim_count
                  }</div>
                  <div><strong>Total Amount:</strong> $${q.ground_truth.total_claim_amount.toLocaleString()}</div>
                </div>
              </div>
            </div>


            <!-- Human Scoring -->
            <div class="scoring-section">
              <h3>üìù Your Scores</h3>
              <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                <strong>Faithfulness:</strong> Are claims in the response supported by the retrieved context?<br>
                <strong>Relevance:</strong> Does the response address the query about disaster impact?
              </p>
              <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 15px;">
                <div class="score-input-group">
                  <label>Faithfulness (0.0 - 1.0):</label>
                  <input type="number" min="0" max="1" step="0.1"
                         onchange="updateScore(${idx}, 'faithfulness', this.value)"
                         placeholder="0.0 - 1.0">
                </div>
                <div class="score-input-group">
                  <label>Relevance (0.0 - 1.0):</label>
                  <input type="number" min="0" max="1" step="0.1"
                         onchange="updateScore(${idx}, 'relevance', this.value)"
                         placeholder="0.0 - 1.0">
                </div>
                <div class="score-input-group">
                  <label>Notes (Optional):</label>
                  <input type="text" onchange="updateScore(${idx}, 'notes', this.value)"
                         placeholder="Why you scored differently from LLMs...">
                </div>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function buildContextHtml(ctx) {
        let html = '<div class="context-box">';

        if (ctx.tweets && ctx.tweets.length > 0) {
          html += `<h4>üê¶ Tweets (${ctx.tweets.length})</h4><ul>`;
          ctx.tweets.forEach((t) => {
            if (typeof t === 'object') {
              // New format with metadata
              const timestamp = t.timestamp && t.timestamp !== 'N/A' ? `<span style="color:#666;font-size:11px;">[${t.timestamp}]</span> ` : '';
              const location = t.location && t.location !== 'N/A' ? `<span style="color:#888;font-size:11px;">üìç${t.location}</span>` : '';
              html += `<li>${timestamp}${t.text || t} ${location}</li>`;
            } else {
              // Old string format
              html += `<li>${t}</li>`;
            }
          });
          html += "</ul>";
        }

        if (ctx.call_311 && ctx.call_311.length > 0) {
          html += `<h4>üìû 311 Calls (${ctx.call_311.length})</h4><ul>`;
          ctx.call_311.forEach((c) => {
            if (typeof c === 'object') {
              // New format with metadata
              const timestamp = c.timestamp && c.timestamp !== 'N/A' ? `<span style="color:#666;font-size:11px;">[${c.timestamp}]</span> ` : '';
              const location = c.location && c.location !== 'N/A' ? `<span style="color:#888;font-size:11px;">üìç${c.location}</span>` : '';
              const type = c.type && c.type !== 'N/A' ? `<span style="color:#007bff;font-size:11px;">[${c.type}]</span> ` : '';
              html += `<li>${timestamp}${type}${c.description || c} ${location}</li>`;
            } else {
              // Old string format
              html += `<li>${c}</li>`;
            }
          });
          html += "</ul>";
        }

        if (ctx.imagery_tiles && ctx.imagery_tiles.length > 0) {
          html += `<h4>üõ∞Ô∏è Imagery Tiles (${ctx.imagery_tiles.length})</h4><ul>`;
          ctx.imagery_tiles.forEach((t) => {
            const date = t.date && t.date !== 'N/A' ? t.date : 'Unknown date';
            const location = t.location && t.location !== 'N/A' ? ` üìç${t.location}` : '';
            html += `<li><strong>${t.tile_id}</strong> - ${date}${location}</li>`;
          });
          html += "</ul>";
        }

        // Only show kb_summary if it has meaningful content (not just empty table)
        if (ctx.kb_summary) {
          // Check if it's not just empty markdown table headers
          const cleanKb = ctx.kb_summary.replace(/[\|\-\s\n]/g, "").trim();
          if (cleanKb.length > 10 && !cleanKb.match(/^yearloss_mean\d*$/)) {
            html += `<h4>üìñ Knowledge Base</h4><p style="font-size: 13px;">${ctx.kb_summary.substring(
              0,
              300
            )}...</p>`;
          }
          // Otherwise skip showing empty KB
        }

        html += "</div>";
        return html;
      }

      function buildJudgeScoresHtml(judgeScores) {
        const judges = Object.entries(judgeScores);
        let html = "";

        judges.forEach(([name, scores]) => {
          const cardClass = name.includes("gpt")
            ? "gpt4o"
            : name.includes("gemini")
            ? "gemini"
            : "hf";
          const f = scores.faithfulness;
          const r = scores.relevance;
          const fClass = f >= 0.7 ? "high" : f >= 0.4 ? "medium" : "low";
          const rClass = r >= 0.7 ? "high" : r >= 0.4 ? "medium" : "low";

          html += `
            <div class="judge-card ${cardClass}">
              <div class="judge-name">${formatJudgeName(name)}</div>
              <div class="judge-scores">
                <span class="score-badge ${fClass}">F: ${
            f !== null ? f.toFixed(2) : "N/A"
          }</span>
                <span class="score-badge ${rClass}">R: ${
            r !== null ? r.toFixed(2) : "N/A"
          }</span>
              </div>
            </div>
          `;
        });

        return html;
      }

      function formatJudgeName(name) {
        const names = {
          "gpt-4o": "üü¢ GPT-4o",
          "gpt-4o-mini": "üü¢ GPT-4o Mini",
          "gemini-2.5-flash": "üîµ Gemini 2.5 Flash",
          "gemma-3-27b": "üü† Gemma 3",
          "qwen3-vl-235b": "üü† Qwen3 VL",
        };
        return names[name] || name;
      }

      function getSeverityBadge(damage_pct) {
        if (damage_pct === 0)
          return '<span class="badge badge-none">No Damage</span>';
        if (damage_pct < 5)
          return '<span class="badge badge-minor">Minor</span>';
        if (damage_pct < 20)
          return '<span class="badge badge-moderate">Moderate</span>';
        return '<span class="badge badge-severe">Severe</span>';
      }

      function updateScore(idx, field, value) {
        scores[idx][field] = field === "notes" ? value : parseFloat(value);
        updateProgress();
      }

      function updateProgress() {
        const completed = scores.filter(
          (s) => s.faithfulness !== null && s.relevance !== null
        ).length;
        const percent = Math.round((completed / 25) * 100);
        document.getElementById(
          "progress-text"
        ).textContent = `${completed}/25 queries scored`;
        document.getElementById("progress-fill").style.width = `${percent}%`;
        document.getElementById("progress-fill").textContent = `${percent}%`;
      }

      function scrollToQuery(direction) {
        currentQuery = Math.max(0, Math.min(24, currentQuery + direction));
        document
          .getElementById(`query-${currentQuery}`)
          .scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function exportToCSV() {
        const completed = scores.filter(
          (s) => s.faithfulness !== null && s.relevance !== null
        ).length;
        if (completed === 0) {
          alert("Please score at least one query before exporting!");
          return;
        }

        let csv =
          "query_id,zip,start_date,end_date,human_faithfulness,human_relevance,notes";
        // Add headers for each judge
        const judgeNames = rawData.judges || [];
        judgeNames.forEach((j) => {
          csv += `,${j}_faithfulness,${j}_relevance`;
        });
        csv += "\n";

        rawData.records.forEach((q, idx) => {
          const row = [
            q.query_id,
            q.query.zip,
            q.query.start_date,
            q.query.end_date,
            scores[idx].faithfulness || "",
            scores[idx].relevance || "",
            `"${(scores[idx].notes || "").replace(/"/g, '""')}"`,
          ];
          // Add judge scores
          judgeNames.forEach((j) => {
            const js = q.judge_scores[j] || {};
            row.push(js.faithfulness || "");
            row.push(js.relevance || "");
          });
          csv += row.join(",") + "\n";
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "human_scores_25.csv";
        a.click();

        alert(
          `‚úÖ Exported! Completed ${completed}/25 queries.\n\nThe CSV includes your scores + all LLM judge scores for correlation analysis.`
        );
      }
    </script>
  </body>
</html>
